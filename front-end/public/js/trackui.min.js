/*! evtrack -- UI module */
!function(o){var s=o.document,i="mousedown mouseup mousemove mouseover mouseout mousewheel wheel";i+=" touchstart touchend touchmove deviceorientation keydown keyup keypress";var a="load unload beforeunload blur focus resize error abort online offline";a+=" storage popstate hashchange pagehide pageshow message beforeprint afterprint",i=(i+=" click dblclick scroll change select submit reset contextmenu cut copy paste").split(" "),a=a.split(" ");var e=i.concat(a),r=0,l=0,c=[],d={settings:{postServer:"//my.server.org/save.script",postInterval:30,regularEvents:"*",pollingEvents:"",pollingMs:150,taskName:"evtrack",callback:null,saveAttributes:!0,debug:!1},record:function(e){for(var t in l=(new Date).getTime(),d.settings)e.hasOwnProperty(t)&&null!==e[t]&&(d.settings[t]=e[t]);d.log("Recording starts...",l,d.settings),d.addEventListeners(),setTimeout(function(){d.initNewData(!0)},1e3*d.settings.postInterval)},addEventListeners:function(){"*"==d.settings.regularEvents?d.addCustomEventListeners(e):(d.log("Settings regular events..."),d.settings.regularEvents=d.settings.regularEvents.split(" "),d.addCustomEventListeners(d.settings.regularEvents)),"*"==d.settings.pollingEvents?d.addCustomEventListeners(e):(d.log("Settings polling events..."),d.settings.pollingEvents=d.settings.pollingEvents.split(" "),d.addCustomEventListeners(d.settings.pollingEvents)),TrackLib.Events.add(o,"beforeunload",d.flush),TrackLib.Events.add(o,"unload",d.flush)},addCustomEventListeners:function(e){d.log("Adding event listeners:",e);for(var t=0;t<e.length;++t){var n=e[t];n&&(-1<i.indexOf(n)?(TrackLib.Events.add(s,n,d.docHandler),d.log("Adding document event:",n),s.attachEvent&&("focus"==n&&TrackLib.Events.add(s.body,"focusin",d.winHandler),"blur"==n&&TrackLib.Events.add(s.body,"focusout",d.winHandler))):-1<a.indexOf(n)&&(TrackLib.Events.add(o,n,d.winHandler),d.log("Adding window event:",n)))}},initNewData:function(e){var t=TrackLib.Dimension.getWindowSize(),n=TrackLib.Dimension.getDocumentSize(),s={url:encodeURIComponent(o.location.href),screenw:screen.width,screenh:screen.height,winw:t.width,winh:t.height,docw:n.width,doch:n.height,info:encodeURIComponent(c.join("|||")),task:encodeURIComponent(d.settings.taskName),action:"init"};if(e||"function"!=typeof navigator.sendBeacon)d.send({async:e,postdata:s,callback:d.setUserId});else{s.beacon=!0;var i=JSON.stringify(s);navigator.sendBeacon(d.settings.postServer,i)}c=[]},setUserId:function(e){r=e.responseText,d.log("setUserId:",r),r&&setInterval(function(){d.appendData(!0)},1e3*d.settings.postInterval)},appendData:function(e){var t={uid:r,info:encodeURIComponent(c.join("|||")),action:"append"};if(e||"function"!=typeof navigator.sendBeacon)0<c.length?d.send({async:e,postdata:t}):d.log("Skipping empty request...");else{t.beacon=!0;var n=JSON.stringify(t);navigator.sendBeacon(d.settings.postServer,n)}c=[]},send:function(e){e.url=d.settings.postServer,TrackLib.XHR.sendAjaxRequest(e)},docHandler:function(e){-1<e.type.indexOf("touch")?d.touchHandler(e):d.eventHandler(e)},winHandler:function(e){d.eventHandler(e)},eventHandler:function(e){if(!("isTrusted"in(e=TrackLib.Events.fix(e)))||e.isTrusted){var t=(new Date).getTime(),n=e.type,s=!0;if(0<d.settings.pollingMs&&-1<d.settings.pollingEvents.indexOf(n)&&(s=t-l>=d.settings.pollingMs),s){var i=d.getMousePos(e),o=TrackLib.XPath.getXPath(e.target),a=d.settings.saveAttributes?TrackLib.Util.serializeAttrs(e.target):"{}",r="{}";"function"==typeof d.settings.callback&&(r=JSON.stringify(d.settings.callback(e))),d.fillInfo(e.id,t,i.x,i.y,n,o,a,r),l=t}}},touchHandler:function(e){if(!("isTrusted"in(e=TrackLib.Events.fix(e)))||e.isTrusted){var t=e.changedTouches;if(t)for(var n,s=0;s<t.length;++s)(n=t[s]).type=e.type,d.eventHandler(n)}},getMousePos:function(e){var t=0,n=0;return(e=TrackLib.Events.fix(e)).pageX||e.pageY?(t=e.pageX,n=e.pageY):(e.clientX||e.clientY)&&(t=e.clientX+s.body.scrollLeft+s.documentElement.scrollLeft,n=e.clientY+s.body.scrollTop+s.documentElement.scrollTop),(!t||t<0)&&(t=0),(!n||n<0)&&(n=0),{x:t,y:n}},fillInfo:function(e){e=[].slice.apply(arguments);c.push(e.join(" ")),d.log(e)},flush:function(e){var t;for(d.log("Flushing data..."),t=0;t<i.length;++t)TrackLib.Events.remove(s,i[t],d.docHandler);for(t=0;t<a.length;++t)TrackLib.Events.remove(o,a[t],d.winHandler);r?d.appendData(!1):d.initNewData(!1)},log:function(e){d.settings.debug&&"function"==typeof console.log&&console.log.apply(console,arguments)}};o.TrackUI=d}(this);